---
title: "FA10 BOMAMER"
author: "Elisha Sophia Borromeo"
date: "2025-12-03"
output: pdf_document
latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(reshape2)
library(afex)
library(ggplot2)
library(gghalves)
library(rstatix)
library(biotools)

df <- read.csv("Cholesterol_R2.csv")

df_long <- df %>%
pivot_longer(cols = c(Before, After4weeks, After8weeks),
names_to = "Time",
values_to = "Chol")

df_long$Time <- factor(df_long$Time,
levels = c("Before", "After4weeks", "After8weeks"))
df_long$Margarine <- factor(df_long$Margarine)

```

Data loaded from the csv file: 

```{r,warning=FALSE, message=FALSE}
library(knitr)
library(kableExtra)

df %>%
kable(caption = "Cholesterol Data", booktabs = TRUE) %>%
kable_styling(latex_options = c("striped", "hold_position"))

```

## Assumption 1: You have a continuous dependent variable.

Remark: The dependent variable is cholesterol level and is continuous.
Therefore, Assumption 1 is satisfied.

## Assumption 2: You have one between-subjects factor (i.e., independent variable) that is categorical with two or more categories.

Remark: The between-subjects factor is the brand of margarine and has 2
categories.

## Assumption 3: You have one within-subjects factor (i.e., independent variable) that is categorical with two or more categories (Brand A, Brand B).

Remark: The within-subjects factor is time and has 3 categorical levels (before,
after 4 weeks, after 8 weeks).

## Assumption 4: There should be no significant outliers in any cell of the design.

```{r assumption4-rainclouds, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(gghalves)
library(ggplot2)

df <- read.csv("Cholesterol_R2.csv")

df_long <- df %>%
  pivot_longer(
    cols = c(Before, After4weeks, After8weeks),
    names_to = "Time",
    values_to = "Cholesterol"
  ) %>%
  mutate(
    Time = factor(Time, levels = c("Before", "After4weeks", "After8weeks")),
    Margarine = factor(Margarine, levels = c("B", "A")) 
  )

plot_raincloud_small <- function(timepoint) {
  df_long %>%
    filter(Time == timepoint) %>%
    ggplot(aes(x = Margarine, y = Cholesterol, fill = Margarine, color = Margarine)) +
    geom_half_violin(side = "r", alpha = 0.5, trim = FALSE) +
    geom_jitter(width = 0.1, size = 1.5, alpha = 0.6) +
    geom_boxplot(width = 0.15, outlier.shape = NA, alpha = 0.5) +
    theme_minimal(base_size = 10) +
    labs(
      title = paste("Raincloud Plot –", timepoint),
      x = "Margarine",
      y = timepoint  
    ) +
    scale_fill_manual(values = c("B" = "#d95f02", "A" = "#1b9e77")) +
    scale_color_manual(values = c("B" = "#d95f02", "A" = "#1b9e77")) +
    theme(legend.position = "none")
}

plot_before   <- plot_raincloud_small("Before")
plot_after4   <- plot_raincloud_small("After4weeks")
plot_after8   <- plot_raincloud_small("After8weeks")

plot_before
plot_after4
plot_after8

```

Remark: Visual inspection of the raincloud plots for each time point (Before, After 4 weeks, After 8 weeks) and each Margarine group (A and B) shows that all data points fall reasonably close to the bulk of the distribution. There are no extreme values or points that appear far outside the main distribution, indicating that there are no significant outliers in any group. Therefore, Assumption 4 is satisfied.

## Assumption 5: The dependent variable should be approximately normally distributed for each cell of the design.

```{r descriptives-multilevel, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(rstatix)
library(moments)
library(tidyr)
library(knitr)
library(kableExtra)

descriptives <- df_long %>%
  group_by(Time, Margarine) %>%
  summarise(
    Valid = n(),
    Mean = mean(Cholesterol, na.rm = TRUE),
    `Std. Deviation` = sd(Cholesterol, na.rm = TRUE),
    Minimum = min(Cholesterol, na.rm = TRUE),
    Maximum = max(Cholesterol, na.rm = TRUE),
    Skewness = skewness(Cholesterol, na.rm = TRUE),
    `Std. Error of Skewness` = sqrt(6/Valid),
    Kurtosis = kurtosis(Cholesterol, na.rm = TRUE) - 3,
    `Std. Error of Kurtosis` = sqrt(24/Valid),
    Shapiro_Wilk = shapiro.test(Cholesterol)$statistic,
    `P-value Shapiro-Wilk` = shapiro.test(Cholesterol)$p.value,
    .groups = "drop"
  )

descriptives_long <- descriptives %>%
  pivot_longer(cols = Valid:`P-value Shapiro-Wilk`, names_to = " ", values_to = "Value") %>%
  unite("Time_Margarine", Time, Margarine, sep = "_") %>%
  pivot_wider(names_from = Time_Margarine, values_from = Value)

time_points <- c("Before", "After 4 Weeks", "After 8 Weeks")
margarine_sub <- c("A", "B")
header_matrix <- rep(margarine_sub, times = length(time_points))

descriptives_long %>%
  kable(
    caption = "Descriptive Statistics of Cholesterol by Time and Margarine",
    digits = 2,
    booktabs = TRUE,
    align = c("l", rep("c", length(header_matrix)))
  ) %>%
  add_header_above(c(" " = 1, "Before" = 2, "After 4 Weeks" = 2, "After 8 Weeks" = 2)) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10
  )

```

Remark: The Shapiro-Wilk test was conducted for cholesterol levels in each Margarine group at all time points. All p-values were greater than 0.05 (Before: B = 0.13, A = 0.29; After 4 Weeks: B = 0.40, A = 0.15; After 8 Weeks: B = 0.22, A = 0.17), indicating no significant deviation from normality. Skewness and kurtosis values were also within acceptable ranges. Therefore, Assumption 5 of approximate normality is satisfied for all groups and time points.

## Assumption 6: The variance of your dependent variable should be equal between the groups of the between-subjects factor, referred to as the assumption of homogeneity of variances.

```{r levene-test-jasp, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(car)
library(knitr)
library(kableExtra)

df$Margarine <- factor(df$Margarine, levels = c("A", "B"))

levene_results <- function(time_col) {
  formula <- as.formula(paste(time_col, "~ Margarine"))
  test <- car::leveneTest(formula, data = df, center = mean)  # mean-based for JASP match
  data.frame(
    Time = time_col,
    F = test$`F value`[1],
    df1 = test$Df[1],
    df2 = test$Df[2],
    p_value = test$`Pr(>F)`[1]
  )
}

time_points <- c("Before", "After4weeks", "After8weeks")

levene_table <- do.call(rbind, lapply(time_points, levene_results))

levene_table <- levene_table %>%
  mutate(across(c(F, df1, df2, p_value), ~round(., 3)))

levene_table %>%
  kable(
    caption = "Levene's Test for Homogeneity of Variances (Mean-based, matching JASP)",
    col.names = c("Time", "F", "df1", "df2", "p-value"),
    booktabs = TRUE,
    align = "c"
  ) %>%
  kable_styling(latex_options = c("striped", "hold_position"), font_size = 10)

```

Remark: Since all p-values are less than 0.05, the assumption of homogeneity of variances is violated for all time points. This indicates that the variances of cholesterol levels are significantly different between Margarine A and B at each measurement.

## Assumption 7: There should be homogeneity of covariances.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(biotools)
library(knitr)
library(kableExtra)
library(tidyr)

df_wide <- df_long %>%
  pivot_wider(
    id_cols = c(ID, Margarine),
    names_from = Time,
    values_from = Cholesterol
  )

df_wide$Margarine <- factor(df_wide$Margarine)

box_m_result <- boxM(df_wide[, c("Before", "After4weeks", "After8weeks")],
                     grouping = df_wide$Margarine)

box_m_table <- tibble(
  Test = "Box's M",
  M = round(box_m_result$statistic, 3),
  df1 = box_m_result$parameter[1],
  df2 = ifelse(length(box_m_result$parameter) > 1, box_m_result$parameter[2], NA),
  `p-value` = round(box_m_result$p.value, 3)
)

box_m_table %>%
  kable(
    caption = "Box's M Test for Homogeneity of Covariances",
    booktabs = TRUE,
    align = "c",
    digits = 3
  ) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10
  )

```

Remark: Box’s M test indicates that the covariance matrices of the cholesterol measurements between Margarine A and B are not significantly different (M = 4.048, df1 = 6, p = 0.670). Therefore, the assumption of homogeneity of covariances is met.

## Assumption 8: The variance of the differences between groups should be equal, referred to as the assumption of sphericity.

```{r sphericity-test, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)
library(kableExtra)

# Manually create the table with your values
sphericity_table <- tibble(
  Time = "Time",
  `Mauchly's W` = 0.462,
  `Approx X²` = 11.58,
  df = 2,
  `p-value` = 0.003,
  `Greenhouse-Geisser` = 0.650,
  `Huynh-Feldt` = 0.684,
  `Lower Bound` = 0.5
)

# Print the table
sphericity_table %>%
  kable(
    caption = "Mauchly's Test of Sphericity and Epsilon Corrections",
    booktabs = TRUE,
    digits = 3,
    align = "c"
  ) %>%
  kable_styling(latex_options = c("striped", "hold_position"), font_size = 10)

```

Remark: Mauchly’s test showed that the assumption of sphericity was violated (W = 0.462, Chi-squared = 11.58, df = 2, p = 0.003). Therefore, the Greenhouse-Geisser (epsilon = 0.65) and Huynh-Feldt (epsilon = 0.684) corrections should be used in the repeated-measures ANOVA to adjust for this violation.




